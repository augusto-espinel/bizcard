<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRON AR - Proximity Interaction</title>
  
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&amp;family=Share+Tech+Mono&amp;display=swap" rel="stylesheet">

  <style>
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Share Tech Mono', monospace; }

    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 5, 10, 0.95);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; z-index: 9999;
      color: #00E5FF;
    }
    h1 { font-family: 'Orbitron', sans-serif; font-size: 2rem; text-align: center; text-shadow: 0 0 10px #00E5FF; }
    #start-btn {
      background: transparent; color: #FFFFFF; font-family: 'Orbitron', sans-serif; font-size: 1.2rem;
      padding: 15px 40px; border: 2px solid #00E5FF; cursor: pointer; margin-top: 30px;
      box-shadow: 0 0 4px #00E5FF, inset 0 0 4px #00E5FF;
    }
    
    /* Center Crosshair */
    #crosshair {
      position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
      border: 2px solid rgba(0, 229, 255, 0.5); border-radius: 50%;
      transform: translate(-50%, -50%); pointer-events: none; z-index: 5000;
    }
  </style>

  <script>
    // --- 1. SHADER (Restored to BLUE #00E5FF) ---
    AFRAME.registerShader('spillover-tunnel', {
      schema: { color: {type: 'color', is: 'uniform', default: '#00E5FF'}, time: {type: 'float', is: 'uniform', default: 0.0} },
      vertexShader: `varying vec3 vPos; void main() { vPos = position; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
      fragmentShader: `
        uniform vec3 color; uniform float time; varying vec3 vPos;
        void main() {
          float r = max(abs(vPos.x), abs(vPos.y)); 
          float a = atan(vPos.y, vPos.x);
          float z = 1.0 / r + (time * 0.5); 
          float gridH = fract(z * 4.0); float gridV = fract(a * 4.0 / 3.14159);
          float thickness = 0.05 * r; 
          float lineH = step(1.0 - thickness, gridH);
          float lineV = step(0.98, gridV); 
          float gridVal = max(lineH, lineV);
          float inWindowX = step(abs(vPos.x), 0.5); float inWindowY = step(abs(vPos.y), 0.3);
          float inWindow = inWindowX * inWindowY;
          vec3 gridColor = color * gridVal; vec3 voidColor = vec3(0.0, 0.02, 0.05);
          vec3 finalRGB = gridColor + (voidColor * inWindow);
          float finalAlpha = max(gridVal, inWindow);
          gl_FragColor = vec4(finalRGB, finalAlpha);
        }
      `
    });

    AFRAME.registerComponent('shader-clock', {
      tick: function (time, timeDelta) {
        const mesh = this.el.getObject3D('mesh');
        if(mesh && mesh.material.uniforms) mesh.material.uniforms.time.value = time / 1000; 
      }
    });

    AFRAME.registerComponent('style-red-wireframe', {
      init: function() {
        this.el.addEventListener('model-loaded', () => {
          const object = this.el.getObject3D('mesh');
          if (!object) return;
          const meshes = [];
          object.traverse((node) => { if (node.isMesh) meshes.push(node); });
          meshes.forEach((node) => {
            node.material = new THREE.MeshStandardMaterial({ color: 0x330000, metalness: 0.6, roughness: 0.4 });
            const wireMesh = new THREE.Mesh(
              node.geometry,
              new THREE.MeshBasicMaterial({ color: 0xFF0000, wireframe: true, transparent: true, opacity: 0.8 })
            );
            node.add(wireMesh);
          });
        });
      }
    });

    AFRAME.registerComponent('ui-logic', {
      init: function() {
        document.getElementById('start-btn').addEventListener('click', () => {
          document.getElementById('overlay').style.display = 'none';
        });
      }
    });

    // --- 2. NEW PROXIMITY SYSTEM ---
    // This replaces Raycasters. It uses Vector Math to see what is "in front" of the camera.
    AFRAME.registerComponent('proximity-selector', {
      init: function() {
        this.camera = document.querySelector('a-camera');
        this.targets = Array.from(document.querySelectorAll('.selectable'));
        this.activeTarget = null;
        
        // GLOBAL CLICK LISTENER
        window.addEventListener('click', () => {
          if (this.activeTarget) {
            const url = this.activeTarget.getAttribute('data-url');
            if(url) {
              console.log("Opening URL:", url);
              window.open(url, '_blank');
            }
          }
        });
      },
      
      tick: function() {
        if (!this.camera) return;
        
        // 1. Get Camera Direction
        const camObject = this.camera.getObject3D('camera');
        if (!camObject) return;
        
        const camPos = new THREE.Vector3();
        const camDir = new THREE.Vector3();
        camObject.getWorldPosition(camPos);
        camObject.getWorldDirection(camDir);
        camDir.negate(); // A-Frame cameras look down negative Z, so we flip it to get "Forward"

        let closestTarget = null;
        let maxDot = 0.96; // Threshold: 0.96 is roughly 15 degrees cone

        // 2. Check every text label
        this.targets.forEach(target => {
          const targetObj = target.object3D;
          const targetPos = new THREE.Vector3();
          targetObj.getWorldPosition(targetPos);
          
          // Calculate vector from Camera to Text
          const dirToTarget = targetPos.sub(camPos).normalize();
          
          // Dot Product: 1.0 = Exact center, 0.0 = 90 degrees away
          const dot = camDir.dot(dirToTarget);
          
          if (dot > maxDot) {
            maxDot = dot;
            closestTarget = target;
          }
        });

        // 3. Update Visuals
        if (closestTarget !== this.activeTarget) {
          // Deactivate old target
          if (this.activeTarget) {
            this.activeTarget.setAttribute('scale', '1.5 1.5 1.5');
            const core = this.activeTarget.querySelector('.text-core');
            if(core) core.setAttribute('color', '#FFFFFF');
          }
          
          // Activate new target
          if (closestTarget) {
            closestTarget.setAttribute('scale', '1.8 1.8 1.8');
            const core = closestTarget.querySelector('.text-core');
            if(core) core.setAttribute('color', '#FF0000');
            
            // Optional: Phone Vibrate
            if(window.navigator.vibrate) window.navigator.vibrate(20);
          }
          
          this.activeTarget = closestTarget;
        }
      }
    });
  </script>
</head>
<body>

  <div id="overlay">
    <h1>SYSTEM ACCESS</h1>
    <button id="start-btn">ENTER GRID</button>
  </div>
  
  <div id="crosshair"></div>

  <a-scene 
    proximity-selector
    ui-logic
    mindar-image="imageTargetSrc: ./targets.mind;" 
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights: true" 
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">

    <a-assets>
      <a-mixin id="label-font"
               text="font: https://raw.githubusercontent.com/etiennepinchon/aframe-fonts/master/fonts/orbitron/Orbitron-Bold.json; 
                     shader: msdf; align: center; width: 4; negate: true"> </a-mixin>
      <a-asset-item id="illusion-model" src="./illusion.glb"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      
      <a-plane shader-clock material="shader: spillover-tunnel; color: #00E5FF; transparent: true; opacity: 1.0" 
        width="30" height="30" position="0 0 -0.02"></a-plane>

      <a-entity position="0 0 0.01">
         <a-plane position="0 0.31 0" width="1.04" height="0.02" material="shader: flat; color: #00E5FF"></a-plane>
         <a-plane position="0 -0.31 0" width="1.04" height="0.02" material="shader: flat; color: #00E5FF"></a-plane>
         <a-plane position="-0.51 0 0" width="0.02" height="0.64" material="shader: flat; color: #00E5FF"></a-plane>
         <a-plane position="0.51 0 0" width="0.02" height="0.64" material="shader: flat; color: #00E5FF"></a-plane>
      </a-entity>

      <a-entity 
        id="illusion-obj"
        gltf-model="#illusion-model"
        style-red-wireframe
        position="0 0 0.02" 
        scale="0.02 0.02 0.02"> 
      </a-entity>

      <a-entity position="0 0.8 0.2" rotation="45 0 0" scale="1.5 1.5 1.5" 
                class="selectable" data-url="https://linkedin.com">
        <a-text value="PROFILE" mixin="label-font" color="#AA0000" opacity="0.8" position="0 0.02 -0.005"></a-text>
        <a-text class="text-core" value="PROFILE" mixin="label-font" color="#FFFFFF"></a-text>
      </a-entity>

      <a-entity position="0 -0.8 0.2" rotation="-45 0 0" scale="1.5 1.5 1.5" 
                class="selectable" data-url="https://github.com">
        <a-text value="PROJECTS" mixin="label-font" color="#AA0000" opacity="0.8" position="0 -0.02 -0.005"></a-text>
        <a-text class="text-core" value="PROJECTS" mixin="label-font" color="#FFFFFF"></a-text>
      </a-entity>

      <a-entity position="-0.9 0 0.2" rotation="0 45 0" scale="1.5 1.5 1.5" 
                class="selectable" data-url="mailto:test@example.com">
        <a-text value="EMAIL" mixin="label-font" align="center" color="#AA0000" opacity="0.8" position="-0.02 0 -0.005"></a-text>
        <a-text class="text-core" value="EMAIL" mixin="label-font" align="center" color="#FFFFFF"></a-text>
      </a-entity>

      <a-entity position="0.9 0 0.2" rotation="0 -45 0" scale="1.5 1.5 1.5" 
                class="selectable" data-url="tel:+123456789">
        <a-text value="CALL" mixin="label-font" align="center" color="#AA0000" opacity="0.8" position="0.02 0 -0.005"></a-text>
        <a-text class="text-core" value="CALL" mixin="label-font" align="center" color="#FFFFFF"></a-text>
      </a-entity>

    </a-entity>
  </a-scene>
</body>
</html>