# AR Portfolio Codebase Guide

## Project Overview
This is an **AR business card experience** using A-Frame and MindAR for image tracking. Users point a device camera at a business card (tracked via `targets.mind`), which triggers an AR overlay with 360° panoramic imagery and interactive buttons.

## Core Architecture

### Three Implementation Variants
- **`index.html`** - Production: Gyroscope-controlled 360° panorama with shader-based pan/tilt + clickable portfolio buttons
- **`debug.html`** - Testing: Minimal scene with on-screen console output (logs events to `#debug-console`)
- **`debug2.html`** - Stencil debugging: Tests viewport masking using Three.js stencil buffer

### Key Dependencies
- **A-Frame 1.5.0**: WebGL scene framework; entities/components/systems paradigm
- **MindAR 1.2.5**: Image recognition library for card tracking via `mindar-image="imageTargetSrc: ./targets.mind;"`
- **Three.js**: Under A-Frame; used directly for stencil/shader configuration

## Custom Components & Patterns

### 1. `link-handler` Component
Attaches click + hover behavior to interactive elements. Hover scales element to 1.05 and highlights background box (cyan). Click opens `data-url` attribute in new tab.
```html
<a-entity class="clickable" link-handler data-url="https://example.com">
  <a-entity class="bg-box"></a-entity>
</a-entity>
```

### 2. `gyro-sync` Component
**Critical pattern**: Captures device orientation (`DeviceOrientationEvent`) and maps motion to shader uniforms (`uPan`, `uTilt`) for panorama viewport control.
- Requests permission via `DeviceOrientationEvent.requestPermission()` (iOS 13+)
- Clamps rotation to ±45° to prevent disorientation
- Updates shader uniforms in real-time: pan drives horizontal rotation, tilt drives vertical clipping

### 3. Custom Shaders
**`portal-shader-gyro`**: Fragment shader converts spherical panorama to rectangular viewport using gyro input:
- Input: Spherical texture (`src`), pan/tilt offsets, zoom factor
- Output: Clipped viewport (0.01–0.99 vertically to hide poles)
- Math: `atan(dir.z, dir.x)` for horizontal wrap, `asin(dir.y)` for vertical

### 4. `stencil-setup` Component (debug2.html)
Demonstrates viewport masking:
- Mask plane (renderOrder=1): colorWrite=false, stencilFunc=AlwaysStencilFunc, stencilOp=Replace
- Content sphere (renderOrder=2): stencilFunc=EqualStencilFunc (only render where mask stencil=1)
- Use this pattern if adding circular/custom viewport masks

## Asset Management
- **Images**: Use `#drone-360` ID; crossorigin="anonymous" required for remote hosting
- **Fonts**: MSDF font from GitHub (aframe-fonts repo) for crisp text scaling
- **Target data**: `targets.mind` is binary; edit via MindAR web studio, never manually

## Important Patterns & Conventions

### Overlay System
- `#overlay` div (absolute, z-index 9999) shown until permission granted
- Hidden via `document.getElementById('overlay').style.display = 'none'` in `enableGyro()`
- Button ID `#start-btn` triggers permission flow

### Event Flow
```
User taps button 
  → requestAccess() 
  → permission check 
  → enableGyro() 
  → hide overlay 
  → listen to deviceorientation 
  → update shader uniforms
```

### Debugging
- Use `debug.html` for console output to screen (see `log()` function)
- Monitor `targetFound` / `targetLost` events on `mindar-image-target` entity
- Three.js materials accessed via `this.el.getObject3D('mesh').material`

## When Modifying This Codebase

### Adding Interactive Elements
1. Wrap in `.clickable` class
2. Add `link-handler` component + `data-url`
3. Include invisible hit plane + visible bg-box + text entity (use btn-bg/btn-text mixins)

### Adjusting Panorama Viewport
- Modify `uZoom` default in shader schema (currently 3.0)
- Adjust vertical clamp bounds in fragment shader (currently 0.01–0.99)
- Test in `debug2.html` first if adding stencil masking

### Fixing Tracking Issues
- Verify `targets.mind` is in root directory
- Check image filename in `imageTargetSrc` path
- Use `debug.html` to see targetFound/targetLost events
- Ensure target image has sufficient feature detail

### Mobile Testing
- Use HTTPS or localhost (DeviceOrientationEvent requires secure context)
- iOS 13+ requires explicit permission grant
- Desktop browsers won't fire deviceorientation; use debug versions

## File Quick Reference
| File | Purpose |
|------|---------|
| `index.html` | Main experience with gyro controls |
| `debug.html` | Minimal test scene with console |
| `debug2.html` | Stencil/viewport masking reference |
| `targets.mind` | Binary target data (generated by MindAR studio) |
| `DJI_*`, `PXL_*` | 360° panorama source images |
